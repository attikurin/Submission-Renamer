<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提出物リネーム屋さん | 安全・安心のファイル整理ツール</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip (ZIP圧縮用) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver (ファイル保存用) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- SortableJS (ドラッグ＆ドロップ並べ替え用) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #f0f9ff;
        }

        /* カスタムスクロールバー */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }

        .drop-zone {
            transition: all 0.3s ease;
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%233B82F6FF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        .drop-zone.dragover {
            background-color: #eff6ff;
            transform: scale(1.01);
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%232563EBFF' stroke-width='3' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        
        .file-item {
            transition: background-color 0.2s;
        }
        .file-item:hover {
            background-color: #f8fafc;
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: #bfdbfe;
        }
        .badge-security {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background-color: #dcfce7;
            color: #166534;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .warning-text {
            font-size: 0.7rem;
            line-height: 1.2;
        }
        details summary {
            list-style: none; /* 標準の三角を消す(一部ブラウザ用) */
        }
        details summary::-webkit-details-marker {
            display: none;
        }
        details summary::before {
            content: '▶';
            display: inline-block;
            margin-right: 4px;
            font-size: 0.7em;
            transition: transform 0.2s;
        }
        details[open] summary::before {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="text-slate-700">

    <!-- ヘッダー -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <i data-lucide="file-signature" class="w-6 h-6"></i>
                </div>
                <h1 class="text-xl md:text-2xl font-bold text-slate-800">提出物リネーム屋さん</h1>
            </div>
            <div class="hidden md:flex items-center gap-4">
                <div class="badge-security" title="ファイルはサーバーにアップロードされません">
                    <i data-lucide="shield-check" class="w-4 h-4 mr-1"></i>
                    完全ローカル処理で安全
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-6xl">

        <!-- 導入文 -->
        <div class="mb-8 text-center">
            <p class="text-lg mb-2">「誰のファイルか分からない...」を解決します。</p>
            <p class="text-sm text-slate-500">タブレット等で回収したバラバラなファイル名を、名簿リストやルールに従って一括変換し、ZIPで整理して保存できます。</p>
            <div class="md:hidden mt-2 flex justify-center">
                <div class="badge-security">
                    <i data-lucide="shield-check" class="w-4 h-4 mr-1"></i>
                    完全ローカル処理
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- 左側：設定・操作エリア -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- STEP 1: ファイル選択 -->
                <div class="bg-white rounded-xl shadow p-5">
                    <h2 class="text-lg font-bold mb-4 flex items-center text-blue-700">
                        <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-sm mr-2">1</span>
                        ファイルを選択
                    </h2>
                    
                    <div id="dropZone" class="drop-zone bg-slate-50 rounded-2xl p-8 text-center cursor-pointer hover:bg-slate-100 relative">
                        <input type="file" id="fileInput" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div class="flex flex-col items-center pointer-events-none">
                            <i data-lucide="upload-cloud" class="w-10 h-10 text-blue-400 mb-2"></i>
                            <p class="font-bold text-slate-600">ここにファイルをドロップ</p>
                            <p class="text-xs text-slate-400 mt-1">またはクリックして選択</p>
                        </div>
                    </div>
                    <div class="mt-3 flex justify-between items-center text-sm text-slate-500">
                        <span id="fileCountDisplay">0 ファイル選択中</span>
                        <button id="clearBtn" class="text-red-500 hover:text-red-700 hidden text-xs flex items-center">
                            <i data-lucide="trash-2" class="w-3 h-3 mr-1"></i>全てクリア
                        </button>
                    </div>
                </div>

                <!-- STEP 2: リネーム設定 -->
                <div class="bg-white rounded-xl shadow p-5">
                    <h2 class="text-lg font-bold mb-4 flex items-center text-blue-700">
                        <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-sm mr-2">2</span>
                        リネーム設定
                    </h2>

                    <!-- タブ切り替え -->
                    <div class="flex border-b border-slate-200 mb-4 text-sm font-medium">
                        <button class="tab-btn px-4 py-2 text-blue-600 border-b-2 border-blue-600 active-tab" data-target="mode-list">名簿リスト</button>
                        <button class="tab-btn px-4 py-2 text-slate-500 hover:text-slate-700" data-target="mode-serial">連番・ルール</button>
                        <button class="tab-btn px-4 py-2 text-slate-500 hover:text-slate-700" data-target="mode-replace">置換</button>
                    </div>

                    <!-- 名簿リストモード -->
                    <div id="mode-list" class="mode-content">
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-slate-700 mb-1">名簿リストを貼り付け</label>
                            <textarea id="nameListInput" rows="6" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="1 田中 太郎&#10;2 佐藤 花子&#10;3 鈴木 一郎&#10;...ExcelからコピペOK"></textarea>
                            <p class="text-xs text-slate-400 mt-1">※上から順にファイルに割り当てられます。</p>
                        </div>
                        <div class="flex items-center gap-2 mb-3">
                             <label class="flex items-center text-sm cursor-pointer">
                                <input type="checkbox" id="keepExtensionList" class="form-checkbox h-4 w-4 text-blue-600 rounded" checked>
                                <span class="ml-2">元の拡張子を維持</span>
                            </label>
                        </div>
                    </div>

                    <!-- 連番・ルールモード -->
                    <div id="mode-serial" class="mode-content hidden">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase">接頭辞 (Prefix)</label>
                                <input type="text" id="prefixInput" class="w-full border rounded p-2 text-sm" placeholder="例: 提出物_">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase">連番開始</label>
                                    <input type="number" id="startNumber" class="w-full border rounded p-2 text-sm" value="1" min="0">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase">桁数</label>
                                    <select id="digitPadding" class="w-full border rounded p-2 text-sm bg-white">
                                        <option value="0">そのまま (1, 2...)</option>
                                        <option value="2">2桁 (01, 02...)</option>
                                        <option value="3" selected>3桁 (001, 002...)</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase">接尾辞 (Suffix)</label>
                                <input type="text" id="suffixInput" class="w-full border rounded p-2 text-sm" placeholder="例: _1学期">
                            </div>
                            <div class="pt-2 border-t">
                                <label class="flex items-center text-sm cursor-pointer">
                                    <input type="checkbox" id="keepExtensionSerial" class="form-checkbox h-4 w-4 text-blue-600 rounded" checked>
                                    <span class="ml-2">元の拡張子を維持</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 置換モード -->
                    <div id="mode-replace" class="mode-content hidden">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase">検索する文字列</label>
                                <input type="text" id="findText" class="w-full border rounded p-2 text-sm" placeholder="例: IMG_">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase">置換後の文字列</label>
                                <input type="text" id="replaceText" class="w-full border rounded p-2 text-sm" placeholder="例: 写真_">
                            </div>
                            <div class="text-xs text-slate-400">
                                ※「検索する文字列」が空欄の場合、何もしません。
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-slate-100">
                        <button id="applyBtn" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-2 px-4 rounded-lg shadow transition flex items-center justify-center gap-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            プレビューに反映
                        </button>
                    </div>
                </div>

                <!-- STEP 4: ダウンロード (スマホレイアウト用) -->
                <div class="bg-blue-50 border border-blue-100 rounded-xl shadow-sm p-5 lg:hidden">
                     <h2 class="text-lg font-bold mb-4 flex items-center text-blue-700">
                        <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-sm mr-2">3</span>
                        保存
                    </h2>
                    <button id="downloadBtnMobile" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        ZIPでまとめて保存
                    </button>
                    <div class="mt-2 p-2 bg-yellow-50 rounded border border-yellow-100">
                        <p class="text-slate-500 warning-text text-center">
                            ※警告が出る場合は<strong>「保存」</strong>または<strong>「継続」</strong>を選択してください。<br>
                            解凍できない場合は下記をご覧ください。
                        </p>
                    </div>
                    <!-- トラブルシューティング(Mobile) -->
                    <details class="mt-2 text-xs text-slate-500 w-full">
                        <summary class="cursor-pointer hover:text-blue-600 font-bold">ZIPファイルが開けない・警告が出る場合</summary>
                        <div class="mt-1 p-2 bg-slate-100 rounded border border-slate-200">
                            <ol class="list-decimal list-inside space-y-1">
                                <li>ダウンロードしたZIPを右クリック</li>
                                <li>「プロパティ」を選択</li>
                                <li>「全般」タブ下部の「セキュリティ」を確認</li>
                                <li>「許可する(Unblock)」にチェックしOK</li>
                                <li>その後、通常通り解凍してください</li>
                            </ol>
                        </div>
                    </details>
                </div>

            </div>

            <!-- 右側：プレビューリスト -->
            <div class="lg:col-span-8">
                <div class="bg-white rounded-xl shadow h-full flex flex-col min-h-[500px]">
                    <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
                        <h2 class="text-lg font-bold flex items-center text-blue-700">
                            <span class="hidden lg:flex bg-blue-100 text-blue-700 w-6 h-6 rounded-full items-center justify-center text-sm mr-2">3</span>
                            リネームプレビュー
                        </h2>
                        <div class="text-xs text-slate-500 flex items-center bg-white px-2 py-1 rounded border">
                            <i data-lucide="arrow-up-down" class="w-3 h-3 mr-1"></i>
                            ドラッグして並べ替え可能
                        </div>
                    </div>
                    
                    <!-- リストヘッダー -->
                    <div class="grid grid-cols-12 gap-4 px-6 py-2 bg-slate-100 text-xs font-bold text-slate-500 uppercase tracking-wider">
                        <div class="col-span-1 text-center">No.</div>
                        <div class="col-span-5">変更前 (Original)</div>
                        <div class="col-span-1 text-center">→</div>
                        <div class="col-span-5">変更後 (New Name)</div>
                    </div>

                    <!-- リスト本体 -->
                    <div id="fileListContainer" class="flex-1 overflow-y-auto p-2 space-y-1 relative">
                        <!-- ここにファイルリストが動的に生成されます -->
                        <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                            <i data-lucide="files" class="w-16 h-16 mb-4 opacity-50"></i>
                            <p>ファイルが選択されていません</p>
                        </div>
                    </div>

                    <!-- フッターエリア -->
                    <div class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-xl hidden lg:block">
                        <div class="flex flex-col items-end gap-2">
                            <button id="downloadBtnDesktop" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed transform hover:-translate-y-1">
                                <i data-lucide="download" class="w-5 h-5"></i>
                                ZIPでまとめて保存
                            </button>
                            
                            <!-- トラブルシューティング(Desktop) -->
                            <details class="mt-2 text-xs text-slate-500 text-left w-full max-w-md ml-auto">
                                <summary class="cursor-pointer hover:text-blue-600 font-bold text-right">ZIPファイルが開けない・警告が出る場合</summary>
                                <div class="mt-2 p-3 bg-slate-100 rounded border border-slate-200">
                                    <p class="font-bold mb-1">Windowsのセキュリティ機能によるものです</p>
                                    <ol class="list-decimal list-inside space-y-1">
                                        <li>ダウンロードしたZIPファイルを右クリック</li>
                                        <li>「プロパティ」を選択</li>
                                        <li>「全般」タブの一番下にある「セキュリティ」項目を確認</li>
                                        <li>「許可する(Unblock)」にチェックを入れて「OK」</li>
                                        <li>その後、通常通り展開（解凍）してください</li>
                                    </ol>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-slate-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm text-slate-400 mb-2">このツールはブラウザ上ですべての処理を行います。ファイルが外部サーバーに送信されることはありません。</p>
            <p class="text-xs text-slate-500">
                &copy; 2024 Educational Tools. Created with Gemini.
            </p>
        </div>
    </footer>

    <!-- ロジック -->
    <script>
        // DOM要素
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileListContainer = document.getElementById('fileListContainer');
        const emptyState = document.getElementById('emptyState');
        const fileCountDisplay = document.getElementById('fileCountDisplay');
        const clearBtn = document.getElementById('clearBtn');
        const applyBtn = document.getElementById('applyBtn');
        const downloadBtnDesktop = document.getElementById('downloadBtnDesktop');
        const downloadBtnMobile = document.getElementById('downloadBtnMobile');
        const statusMsg = document.getElementById('statusMsg');

        // 設定入力要素
        const tabBtns = document.querySelectorAll('.tab-btn');
        const modeContents = document.querySelectorAll('.mode-content');
        const nameListInput = document.getElementById('nameListInput');
        const keepExtensionList = document.getElementById('keepExtensionList');
        const prefixInput = document.getElementById('prefixInput');
        const suffixInput = document.getElementById('suffixInput');
        const startNumber = document.getElementById('startNumber');
        const digitPadding = document.getElementById('digitPadding');
        const keepExtensionSerial = document.getElementById('keepExtensionSerial');
        const findText = document.getElementById('findText');
        const replaceText = document.getElementById('replaceText');

        // 状態管理
        let files = []; // { id, file, originalName, newName }
        let currentMode = 'mode-list'; // 'mode-list', 'mode-serial', 'mode-replace'
        let sortableInstance = null;

        // 初期化
        lucide.createIcons();
        updateUI();

        // ---------------------------------------------------------
        // イベントリスナー: ファイル入力
        // ---------------------------------------------------------
        
        // ドラッグ&ドロップ
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // クリック選択
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            fileInput.value = ''; // 同じファイルを再度選択可能にする
        });

        // ファイル処理
        function handleFiles(fileList) {
            if (!fileList || fileList.length === 0) return;

            const newFiles = Array.from(fileList).map(file => ({
                id: Math.random().toString(36).substr(2, 9),
                file: file,
                originalName: file.name,
                newName: file.name // 初期値は元の名前
            }));

            files = [...files, ...newFiles];
            updateFileList();
            applyRenameRules(); // 追加時にルール適用
            updateUI();
        }

        // クリアボタン
        clearBtn.addEventListener('click', () => {
            if(confirm('全てのファイルをリストから削除しますか？')) {
                files = [];
                updateFileList();
                updateUI();
            }
        });

        // ---------------------------------------------------------
        // イベントリスナー: タブ切り替え
        // ---------------------------------------------------------
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // タブの見た目更新
                tabBtns.forEach(b => {
                    b.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'active-tab');
                    b.classList.add('text-slate-500');
                });
                btn.classList.remove('text-slate-500');
                btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'active-tab');

                // コンテンツ表示切替
                const target = btn.dataset.target;
                currentMode = target;
                modeContents.forEach(c => c.classList.add('hidden'));
                document.getElementById(target).classList.remove('hidden');
            });
        });

        // ---------------------------------------------------------
        // リネームロジック
        // ---------------------------------------------------------
        
        // 「プレビューに反映」ボタン
        applyBtn.addEventListener('click', () => {
            applyRenameRules();
            
            // ボタンのアニメーションフィードバック
            const originalText = applyBtn.innerHTML;
            applyBtn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> 反映しました`;
            lucide.createIcons();
            setTimeout(() => {
                applyBtn.innerHTML = originalText;
                lucide.createIcons();
            }, 1500);
        });

        function applyRenameRules() {
            if (files.length === 0) return;

            // 現在の並び順に基づいて処理するため、DOMの並び順を取得するのではなく、
            // files配列自体は並べ替え時に更新されている前提で処理する
            // (SortableJSのonEndイベントでfiles配列を更新する)

            if (currentMode === 'mode-list') {
                // 名簿リストモード
                const rawText = nameListInput.value.trim();
                const lines = rawText.split(/\r\n|\r|\n/).filter(line => line.trim() !== '');
                const keepExt = keepExtensionList.checked;

                files.forEach((f, index) => {
                    // 名簿の行があればそれを使用、なければ元の名前などを適当に
                    if (index < lines.length) {
                        let newNameBase = lines[index].trim();
                        // 禁則文字の置換 (Windowsファイル名などで使えない文字)
                        newNameBase = newNameBase.replace(/[\\/:*?"<>|]/g, '_');
                        
                        if (keepExt) {
                            const ext = getExtension(f.originalName);
                            f.newName = newNameBase + (ext ? `.${ext}` : '');
                        } else {
                            f.newName = newNameBase;
                        }
                    } else {
                        // 名簿が足りない場合
                        f.newName = `(名簿なし)_${f.originalName}`;
                    }
                });

            } else if (currentMode === 'mode-serial') {
                // 連番モード
                const prefix = prefixInput.value;
                const suffix = suffixInput.value;
                const start = parseInt(startNumber.value) || 1;
                const padding = parseInt(digitPadding.value);
                const keepExt = keepExtensionSerial.checked;

                files.forEach((f, index) => {
                    const num = start + index;
                    let numStr = num.toString();
                    if (padding > 0) {
                        numStr = numStr.padStart(padding, '0');
                    }
                    
                    let newNameBase = `${prefix}${numStr}${suffix}`;
                    // 禁則文字の置換
                    newNameBase = newNameBase.replace(/[\\/:*?"<>|]/g, '_');

                    if (keepExt) {
                        const ext = getExtension(f.originalName);
                        f.newName = newNameBase + (ext ? `.${ext}` : '');
                    } else {
                        f.newName = newNameBase;
                    }
                });

            } else if (currentMode === 'mode-replace') {
                // 置換モード
                const find = findText.value;
                const rep = replaceText.value;

                if (find) {
                    files.forEach(f => {
                        // 単純置換 (全て置換)
                        f.newName = f.originalName.split(find).join(rep);
                    });
                } else {
                     // 検索文字がない場合は元に戻すか何もしない
                     // ここでは何もしない（前回の状態維持だと混乱するので元の名前に戻す）
                     files.forEach(f => {
                         f.newName = f.originalName;
                     });
                }
            }

            // 重複チェックと解消 ( (1), (2) を付与)
            resolveNameCollisions();
            
            // UI更新
            renderFileList();
        }

        // ファイル名の重複解消
        function resolveNameCollisions() {
            const nameMap = {};
            
            files.forEach(f => {
                if (nameMap[f.newName]) {
                    // 重複発生
                    let count = 1;
                    let base = f.newName;
                    let ext = '';
                    const lastDot = base.lastIndexOf('.');
                    if (lastDot !== -1) {
                        ext = base.substring(lastDot);
                        base = base.substring(0, lastDot);
                    }
                    
                    let candidate = `${base}(${count})${ext}`;
                    while (nameMap[candidate]) {
                        count++;
                        candidate = `${base}(${count})${ext}`;
                    }
                    f.newName = candidate;
                    nameMap[candidate] = true;
                } else {
                    nameMap[f.newName] = true;
                }
            });
        }

        function getExtension(filename) {
            return filename.slice((filename.lastIndexOf(".") - 1 >>> 0) + 2);
        }

        // ---------------------------------------------------------
        // UI更新・描画
        // ---------------------------------------------------------
        
        function updateUI() {
            const hasFiles = files.length > 0;
            if (hasFiles) {
                emptyState.style.display = 'none';
                clearBtn.classList.remove('hidden');
                downloadBtnDesktop.disabled = false;
                downloadBtnMobile.disabled = false;
                downloadBtnDesktop.classList.remove('opacity-50', 'cursor-not-allowed');
                downloadBtnMobile.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                emptyState.style.display = 'flex';
                clearBtn.classList.add('hidden');
                downloadBtnDesktop.disabled = true;
                downloadBtnMobile.disabled = true;
                downloadBtnDesktop.classList.add('opacity-50', 'cursor-not-allowed');
                downloadBtnMobile.classList.add('opacity-50', 'cursor-not-allowed');
            }
            fileCountDisplay.textContent = `${files.length} ファイル選択中`;
        }

        function updateFileList() {
            renderFileList();
            // SortableJSの初期化（初回のみ、またはDOM再生成時）
            initSortable();
        }

        function renderFileList() {
            fileListContainer.innerHTML = '';
            
            if (files.length === 0) {
                fileListContainer.appendChild(emptyState);
                return;
            }

            files.forEach((f, index) => {
                const el = document.createElement('div');
                el.className = 'file-item grid grid-cols-12 gap-4 px-6 py-3 border-b border-slate-100 items-center text-sm cursor-grab active:cursor-grabbing bg-white';
                el.dataset.id = f.id;
                
                // 変更前と変更後で名前が変わっているかチェック
                const isChanged = f.originalName !== f.newName;
                const newNameClass = isChanged ? 'font-bold text-blue-600' : 'text-slate-600';

                el.innerHTML = `
                    <div class="col-span-1 text-center text-slate-400 font-mono select-none">${index + 1}</div>
                    <div class="col-span-5 truncate text-slate-500" title="${f.originalName}">${f.originalName}</div>
                    <div class="col-span-1 text-center text-slate-300"><i data-lucide="arrow-right" class="w-4 h-4 mx-auto"></i></div>
                    <div class="col-span-5 truncate ${newNameClass}" title="${f.newName}">${f.newName}</div>
                    <div class="absolute right-2 top-1/2 transform -translate-y-1/2 opacity-0 hover:opacity-100 transition-opacity">
                         <button class="delete-btn text-red-400 hover:text-red-600 p-1" onclick="removeFile('${f.id}')">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                
                // ホバーで削除ボタン表示のためのスタイル調整
                el.addEventListener('mouseenter', () => {
                    el.querySelector('.absolute').classList.remove('opacity-0');
                });
                el.addEventListener('mouseleave', () => {
                    el.querySelector('.absolute').classList.add('opacity-0');
                });

                fileListContainer.appendChild(el);
            });
            
            lucide.createIcons();
        }

        function initSortable() {
            if (sortableInstance) {
                sortableInstance.destroy();
            }
            
            sortableInstance = new Sortable(fileListContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                handle: '.file-item', // 全体がハンドル
                onEnd: function (evt) {
                    // 並び替え後のDOM順序に合わせてfiles配列を更新
                    const newOrderIds = Array.from(fileListContainer.children).map(el => el.dataset.id);
                    
                    const newFiles = [];
                    newOrderIds.forEach(id => {
                        const file = files.find(f => f.id === id);
                        if (file) newFiles.push(file);
                    });
                    
                    files = newFiles;
                    
                    // 並び順が変わったので、ルールを再適用（特に連番やリスト順の場合）
                    applyRenameRules();
                }
            });
        }

        // グローバル関数として公開（HTML内onclick用）
        window.removeFile = function(id) {
            files = files.filter(f => f.id !== id);
            updateFileList();
            updateUI();
            applyRenameRules(); // 削除により連番などがずれるため再計算
        };

        // ---------------------------------------------------------
        // ダウンロード処理
        // ---------------------------------------------------------
        
        const handleDownload = async () => {
            if (files.length === 0) return;

            const btn = document.getElementById('downloadBtnDesktop'); // モバイルも連動させる想定
            const originalText = btn.innerHTML;
            
            // ローディング表示
            const setBtnState = (state, text) => {
                const btns = [downloadBtnDesktop, downloadBtnMobile];
                btns.forEach(b => {
                    if (state === 'loading') {
                        b.disabled = true;
                        b.innerHTML = `<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> ${text}`;
                    } else {
                        b.disabled = false;
                        b.innerHTML = originalText;
                    }
                });
                lucide.createIcons();
            };

            setBtnState('loading', 'ZIP圧縮中...');

            try {
                const zip = new JSZip();
                
                // 重複ファイル名の最終確認（念のため）
                resolveNameCollisions();

                files.forEach(f => {
                    zip.file(f.newName, f.file);
                });

                // MIMEタイプを明示的に指定してBlobを生成
                const content = await zip.generateAsync({
                    type: "blob",
                    mimeType: "application/zip"
                });
                
                // 日付入りファイル名
                const date = new Date();
                const dateStr = `${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}`;
                saveAs(content, `提出物一括_${dateStr}.zip`);
                
                setBtnState('idle');
                
            } catch (error) {
                console.error(error);
                alert('エラーが発生しました: ' + error.message);
                setBtnState('idle');
            }
        };

        downloadBtnDesktop.addEventListener('click', handleDownload);
        downloadBtnMobile.addEventListener('click', handleDownload);

    </script>
</body>
</html>